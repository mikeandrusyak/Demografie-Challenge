```{r}
library(readxl)
```

```{r}
# We create a function for reading all sheets and extracting the first column
read_excel_data <- function(file_path) {
  # We get all sheet names
  sheet_names <- excel_sheets(file_path)
  
  # Dictionary for storing results
  data_list <- list()
  
  # We go through all the sheets and extract the first column
  for (sheet in sheet_names) {
    # Read data from each sheet
    sheet_data <- read_excel(file_path, sheet = sheet)
    
    # If the sheet is not empty, extract the first column
    if (ncol(sheet_data) > 0) {
      data_list[[sheet]] <- sheet_data[[1]]
    }
  }
  
  return(data_list)
}
```

```{r}
# Path to the folder with Excel files
folder_path <- "data/strukturerhebung/"
folder_path
```

```{r}
# Get all Excel files in the folder
file_pattern <- "do-d-40-se_user-syn-(201[0-9]|2020|2021)\\.xls"
file_names <- list.files(folder_path, pattern = file_pattern, full.names = TRUE, recursive = TRUE)
file_names
```

```{r}
# Create a dictionary to store all the results
all_data <- list()
```

```{r}
# Read each file and store the result
for (file in file_names) {
  all_data[[basename(file)]] <- read_excel_data(file)
}

# The result will be stored in all_data, which is a list
# all_data[[file_name]][[sheet_name]] gives access to the first column of each sheet
```
```{r}
all_data[['do-d-40-se_user-syn-2010.xlsx']]['ZP']
```
```{r}
variables_list <- c(
  "HIGHESTCOMPLEDU",
  "CURRACTIVITY_FULL",
  "CURRACTIVITY_PART",
  "CURRACTIVITY_STUDENT",
  "HH_FAMU18",
  "HH_FAMU18_CHILDREN",
  "HH_FAMU18_PARENTS",
  "HH_FAMU25",
  "HH_FAMU25_CHILDREN",
  "HH_FAMU25_PARENTS",
  "NATIONALITYAGG",
  "NATIONALITYCAT",
  "SOCIOECONOMICGROUP",
  "HH_HIGHESTCOMPLEDUAGGI",
  "HH_HIGHESTCOMPLEDUAGGII",
  "TYPEOFOWNERSHIP",
  "HH_CURRACTIVITYSTATUSI-II",
  "HH_COUNTOFMALEMINOR",
  "HH_COUNTOFFEMALEMINOR",
  "HH_COUNTOFMALEU25",
  "HH_COUNTOFFEMALEU25",
  "MIGRATIONSTATUSAGG",
  "CLASSAGECAT",
  "HH_NATIONALITYID",
  "HH_MUNSTAYDURATION",
  "HH_RES_MUSIZE",
  "MARITALSTATUS"
)
```

```{r}
# Create a table for the results
file_names <- names(all_data) # file names
sheet_names <- lapply(all_data, names) # sheet names in each file
file_names
```

```{r}
# Prepare an empty matrix for the results
result_matrix <- matrix(0, nrow = length(variables_list), ncol = length(file_names))
rownames(result_matrix) <- variables_list
colnames(result_matrix) <- file_names
```

```{r}
# Checking each sheet in the file
for (file_idx in seq_along(file_names)) {
  file <- file_names[file_idx]
  for (var_idx in seq_along(variables_list)) {
    var <- variables_list[var_idx]
    
    found <- FALSE  # Flag to check if the variable is found
    
    for (sheet in sheet_names[[file]]) {
      # Get the data from the sheet
      sheet_data <- all_data[[file]][[sheet]]
      
      # Check if the sheet data is a list or vector
      if (is.list(sheet_data) || is.vector(sheet_data)) {
        # Check if the variable is present in this list or vector
        if (var %in% unlist(sheet_data)) {  # unlist converts the list into a vector
          found <- TRUE
          break  # Exit the loop if found
        }
      }
    }
    
    # Store the result: 1 if found, 0 if not found
    if (found) {
      result_matrix[var_idx, file_idx] <- 1
    } else {
      result_matrix[var_idx, file_idx] <- 0
    }
  }
}
```

```{r}
# Convert the matrix to a DataFrame for convenience
result_df <- as.data.frame(result_matrix)

# Output the result
print(result_df)
```

