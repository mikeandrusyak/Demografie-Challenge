```{r}
library(readxl)
library(dplyr)

```

```{r}
# Function to read all sheets in an Excel file and extract the first column
read_excel_data <- function(file_path) {
  sheet_names <- excel_sheets(file_path)
  data_list <- setNames(vector("list", length(sheet_names)), sheet_names)
  
  for (sheet in sheet_names) {
    sheet_data <- read_excel(file_path, sheet = sheet)
    if (ncol(sheet_data) > 0) {
      data_list[[sheet]] <- sheet_data[[1]]  # Extract the first column if not empty
    }
  }
  data_list
}
```

```{r}
# Path to the folder with Excel files
folder_path <- "data/strukturerhebung/"

# Get all Excel files in the folder that match the pattern
file_pattern <- "do-d-40-se_user-syn-(201[0-9]|2020|2021)\\.xls"
file_names <- list.files(folder_path, pattern = file_pattern, full.names = TRUE, recursive = TRUE)
file_names <- file_names[!grepl("^~\\$", basename(file_names))]  # Exclude temporary files

# Load variables from files
zp_variables <- readRDS("zp_variables.rds")
hh_variables <- readRDS("hh_variables.rds")
hhm_variables <- readRDS("hhm_variables.rds")
variables_list <- c(zp_variables, hh_variables, hhm_variables)
file_names
```

```{r}
# Read each file and store results in a named list
all_data <- list()
for (file in file_names) {
  all_data[[basename(file)]] <- read_excel_data(file)
}
```

```{r}
# Завантаження змінних з файлів
zp_variables <- readRDS("zp_variables.rds")
hh_variables <- readRDS("hh_variables.rds")
hhm_variables <- readRDS("hhm_variables.rds")
```

```{r}
variables_list <- c(zp_variables,hh_variables,hhm_variables)
```

```{r}
# Create a table for the results
file_names <- names(all_data) # file names
sheet_names <- lapply(all_data, names) # sheet names in each file
<<<<<<< Updated upstream
file_names
=======
```


```{r}
variables_zp <- c("WORKSTATUS","WORKSTATUSDETAIL", "WORKSTATUS_DETAIL","CURRACTIVITY_FULL",
                   "CURRACTIVITY_PART", "CURRACTIVITY_MULTI","CURRACTIVITY_DISOCC",
                   "CURRACTIVITY_STUDENT", "COMPANY_DISTRICT","COMPANY_CANTON", 
                   "CHARRIVALYEAR", "YEAROFARRIVAL", "YEAROFCITIZACQ_SWISS","MIGRATIONSTATUS",
                   "CITIZBIRTHANDTODAY", "RESIDENTPERMIT", "SEX","RES_CANTON", "NATIONALITYAGG", 
                   "NATIONALITYCAT", "NATIONALITYCONTI","NATIONALITYID", "NATIONALITYSTATE",
                   "AGE","TIMEWORKEDPERWEEKSUM","STATUSINEMPLOYMENT","STATUSINEMPLDETAIL", "STATUSINEMPL_DETAIL",
                   "PROTECTEDWORKPLACE","CURROCCUPATIONISCOAGG","CURROCCUPATIONISCO")
variables_hh <- c("HH_NATAGG_GROUPS", "HH_NATCAT_GROUPS","HOUSEHOLDYEARLYID")
variables_hhm <- c("HOUSEHOLDYEARLYID","HH_AGE", "HH_FAMILYREUNION", "HH_MARITALSTATUS", "HH_CLASSOFMARITALSTATUS",
                   "HH_NATIONALITYAGG", "HH_NATIONALITYCAT", "HH_NATIONALITYCONTI", "HH_NATIONALITYID",
                   "HH_NATIONALITYSTATE", "HH_SEX")
variables_list <- unique(c(variables_zp, variables_hh, variables_hhm))
```

```{r}
path_save = "questions_answers/nationality_econ_status/"
saveRDS(variables_list, paste0(path_save,"nationality_econ_status.rds"))
saveRDS(variables_zp, paste0(path_save,"variables_zp.rds"))
saveRDS(variables_hh, paste0(path_save,"variables_hh.rds"))
saveRDS(variables_hhm, paste0(path_save,"variables_hhm.rds"))
>>>>>>> Stashed changes
```

```{r}
# Create an empty data frame to store results with variables as row names
result_df <- data.frame(matrix(0, nrow = length(variables_list), ncol = length(file_names)),
                        row.names = variables_list)
colnames(result_df) <- file_names
```

```{r}
# Check if each variable is found in any sheet of each file
for (file in file_names) {
  file_basename <- basename(file)
  
  for (var in variables_list) {
    found <- FALSE
    
    for (sheet in names(all_data[[file_basename]])) {
      sheet_data <- unlist(all_data[[file_basename]][[sheet]])
      
      if (var %in% sheet_data) {
        result_df[var, file_basename] <- 1
        found <- TRUE
        break  # Stop searching this file if variable is found
      }
    }
    
    if (!found) {
      result_df[var, file_basename] <- 0
    }
  }
}
```

```{r}
# Convert the matrix to a DataFrame for convenience
result_df <- as.data.frame(result_matrix)

# Output the result
print(result_df)
```
```{r}
library(visdat)
```

```{r}
vis_value(result_df)
```
```{r}
result_df %>% filter(`do-d-40-se_user-syn-2015.xls` == 0) %>% rownames(.)

```
```{r}
 result_df %>% filter(`do-d-40-se_user-syn-2020.xlsx` == 0) %>% rownames(.)
```


```{r}
# Create a list to store the results with detailed information
result_list <- list()

# Checking each sheet in each file
for (file_idx in seq_along(file_names)) {
  file <- file_names[file_idx]
  for (var_idx in seq_along(variables_list)) {
    var <- variables_list[var_idx]
    
    # Flag to check if the variable is found on any sheet
    found_anywhere <- FALSE  
    
    for (sheet in sheet_names[[file]]) {
      # Get the data from the sheet
      sheet_data <- all_data[[file]][[sheet]]
      
      # Check if the sheet data is a list or vector
      if (is.list(sheet_data) || is.vector(sheet_data)) {
        # Check if the variable is present in this list or vector
        if (var %in% unlist(sheet_data)) {
          # Add the information to result_list for each sheet where the variable is found
          result_list[[length(result_list) + 1]] <- data.frame(
            Variable = var,
            File = file,
            Sheet = sheet,
            Found = 1
          )
          
          found_anywhere <- TRUE
          # Continue checking other sheets, don't break the loop
        }
      }
    }
    
    # If the variable was not found in any sheet of the file, still add the result
    if (!found_anywhere) {
      result_list[[length(result_list) + 1]] <- data.frame(
        Variable = var,
        File = file,
        Sheet = NA,
        Found = 0
      )
    }
  }
}

# Combine the list into a data frame
result_df_detailed <- do.call(rbind, result_list)

# Output the result
print(result_df_detailed)

```
```{r}
library(dplyr)

# Filter rows where Sheet is "ZP"
filtered_ZP <- result_df_detailed %>% filter(Sheet == "ZP")

# Output the result
filtered_ZP
```
```{r}
c(filtered_ZP$Variable) %>% unique()
```


```{r}
# Filter rows where Sheet is "HH"
filtered_HH <- result_df_detailed %>% filter(Sheet == "HH")

# Output the result
filtered_HH
```
```{r}
library(stringr)
filtered_ZP_by_year <- result_df_detailed %>% filter(Sheet == "ZP", str_detect(File, "2020"))
filtered_ZP_by_year
```

```{r}
library(stringr)
filtered_by_year <- result_df_detailed %>%
  filter(str_detect(File, "2015")) %>%
  arrange(Variable)  
filtered_by_year
```
```{r}
c(filtered_ZP_by_year$Variable)
```



