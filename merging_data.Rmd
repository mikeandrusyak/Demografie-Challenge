```{r}
library(dplyr)
library(readr)
source("Renaming_Columns.R")
```

```{r}
# === 1. Загрузка переменных ===
path_save = "questions_answers/Level_education-current_employment_-Ivan/"
variables_zp <- readRDS(paste0(path_save,"variables_zp.rds"))

# Убедимся, что переменная variables_zp — это вектор символов
variables_zp <- unlist(variables_zp)

```


```{r}
# === 2. Функция для загрузки данных из CSV-файла ===
load_data <- function(year, file_type, variables) {
  file_path <- paste0("data/strukturerhebung/", year, "_SE_RS_CSV/", file_type, year, ".csv")
  
  if (file.exists(file_path)) {
    if (year == 2011 & file_type == "hhm_") {
      data <- read.csv(file_path, sep = ",")
    } else {
      data <- read.csv(file_path, sep = ";")
    }
    colnames(data) <- toupper(colnames(data))
    data$YEAR_QUIZ <- year
    
    # Преобразуем variables в вектор символов
    variables <- as.character(unlist(variables))
    
    # Проверяем, что переменные — это символы
    if (!is.character(variables)) {
      stop("Ошибка: variables должны быть вектором символов.")
    }
    
    # Фильтруем данные по указанным переменным
    data <- data %>% select(any_of(c(variables, "CURRACTIVITYSTATUSIII",
                       "CURRACTIVITY_FULL", "CURRACTIVITY_PART",
                       "CURRACTIVITY_HOME","IN_EDUCATION",
                       "HIGHESTCOMPLEDU","HIGHESTCOMPLEDUAGGI")))
    return(data)
  } else {
    message(paste("Файл не знайдено:", file_path))
    return(NULL)
  }
}
```

```{r}

# === 3. Функция для загрузки всех данных за диапазон годов ===
load_all_data <- function(start_year, end_year, file_type, variables) {
  data_list <- list()
  
  for (year in start_year:end_year) {
    data <- load_data(year, file_type, variables)
    if (!is.null(data)) {
      data_list[[as.character(year)]] <- data
    }
  }
  
  return(data_list)
}

```

```{r}
# Функція для уніфікації типів колонок
unify_column_types <- function(data_list) {
  all_columns <- unique(unlist(lapply(data_list, names)))
  
  for (col in all_columns) {
    column_types <- sapply(data_list, function(df) {
      if (col %in% names(df)) class(df[[col]]) else NA
    })
    
    if (length(unique(na.omit(column_types))) > 1) {
      data_list <- lapply(data_list, function(df) {
        if (col %in% names(df)) df[[col]] <- as.character(df[[col]])
        return(df)
      })
    }
  }
  
  return(data_list)
}
```

```{r}
# === 5. Функция для объединения всех данных за диапазон годов ===
merging <- function(start_year, end_year, file_type, variables) {
  data_list <- load_all_data(start_year, end_year, file_type, variables)
  
  # Проверим, что data_list не пуст
  if (length(data_list) == 0) {
    stop("Ошибка: Не удалось загрузить данные для указанных годов.")
  }
  
  merged_data <- data_list[[as.character(start_year)]]
  for (year in (start_year + 1):end_year) {
    if (!is.null(data_list[[as.character(year)]])) {
      merged_data <- bind_rows(merged_data, data_list[[as.character(year)]])
    }
  }
  
  # Сохраняем файл CSV
  file_path <- paste0("questions_answers/Level_education-current_employment_-Ivan/", file_type, "merged_data.csv")
  write.csv(merged_data, file_path, row.names = FALSE)
  message(paste("Файл сохранён по пути:", file_path))
  
  return(merged_data)
}
```

```{r}
zp_data_list <- merging(2010, 2019, "zp_", c(variables_zp))
```



