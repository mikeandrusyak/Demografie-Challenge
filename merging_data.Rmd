Purpose

This script automates the process of loading, processing, and merging CSV data files across multiple years. It is designed to standardize and filter data based on predefined variables for further analysis.

Quick Start Guide

1. Data Preparation
	•	Place CSV files in the folder: data/strukturerhebung/.
	•	Ensure file names follow the pattern: {year}_SE_RS_CSV/{file_type}{year}.csv.
	•	Example for household data: 2011_SE_RS_CSV/hhm_2011.csv.

2. Run the Script

Step 1: Load Variables
	1.	Predefined Variables:
	•	variables_zp (individual-level variables).
	•	variables_hh (household-level variables).
	2.	Load these variables into the script from previously saved .rds files:
		path_save <- "questions_answers/home_owner_ship/"
		variables_zp <- readRDS(paste0(path_save, "variables_zp.rds"))
		variables_hh <- readRDS(paste0(path_save, "variables_hh.rds"))
Step 2: Load Data for a Specific Year
	•	Use the load_data() function to load data for a specific year and file type:
		data_2011 <- load_data(2011, "zp_", variables_zp)

Step 3: Load Data for Multiple Years
	•	Use the load_all_data() function to load data for a range of years:
		data_list <- load_all_data(2010, 2021, "zp_", variables_zp)
Step 4: Unify Column Types
	•	Ensure column types are consistent across all datasets:
		unified_data_list <- unify_column_types(data_list)
Step 5: Merge Data Across Years
	•	Use the merging() function to combine data across multiple years:
		merged_data <- merging(2010, 2021, "zp_", variables_zp)
	•	The merged dataset will be saved as a .csv file in the questions_answers/home_owner_ship/ directory.

3. Output Files
	•	Filtered Data:
	•	Individual-year data are saved temporarily in R objects for inspection.
	•	Merged Data:
	•	Combined data across years is saved as zp_merged_data.csv or hhm_merged_data.csv in the output directory.

```{r}
library(dplyr)
library(readr)
source("Renaming_Columns.R")
```

```{r}
# Завантаження змінних з файлів
path_save = "questions_answers/home_owner_ship/"
variables_zp <- readRDS(paste0(path_save,"variables_zp.rds"))
variables_hh <- readRDS(paste0(path_save,"variables_hh.rds"))
# variables_hhm <- readRDS(paste0(path_save,"variables_hhm.rds"))
```

```{r}
# merged_variables <- c(vatriables_zp,variables_hh)
```


```{r}
# === 2. Функция для загрузки данных из CSV-файла ===
load_data <- function(year, file_type, variables) {
  file_path <- paste0("data/strukturerhebung/", year, "_SE_RS_CSV/", file_type, year, ".csv")
  
  if (file.exists(file_path)) {
    if (year == 2011 & file_type == "hhm_") {
      data <- read.csv(file_path, sep = ",")
    } else {
      data <- read.csv(file_path, sep = ";")
    }
    colnames(data) <- toupper(colnames(data))
    data$YEAR_QUIZ <- year
    
    # Преобразуем variables в вектор символов
    variables <- as.character(unlist(variables))
    
    # Проверяем, что переменные — это символы
    if (!is.character(variables)) {
      stop("Ошибка: variables должны быть вектором символов.")
    }
    
    # Фильтруем данные по указанным переменным
    data <- data %>% select(any_of(c(variables, "CURRACTIVITYSTATUSIII",
                       "CURRACTIVITY_FULL", "CURRACTIVITY_PART",
                       "CURRACTIVITY_HOME","IN_EDUCATION",
                       "HIGHESTCOMPLEDU","HIGHESTCOMPLEDUAGGI", "AGE","SEX","CURROCCUPATIONISCO")))
    return(data)
  } else {
    message(paste("Файл не знайдено:", file_path))
    return(NULL)
  }
}
```

```{r}

# === 3. Функция для загрузки всех данных за диапазон годов ===
load_all_data <- function(start_year, end_year, file_type, variables) {
  data_list <- list()
  
  for (year in start_year:end_year) {
    data <- load_data(year, file_type, variables)
    if (!is.null(data)) {
      data_list[[as.character(year)]] <- data
    }
  }
  
  return(data_list)
}

```

```{r}
# Функція для уніфікації типів колонок
unify_column_types <- function(data_list) {
  all_columns <- unique(unlist(lapply(data_list, names)))
  
  for (col in all_columns) {
    column_types <- sapply(data_list, function(df) {
      if (col %in% names(df)) class(df[[col]]) else NA
    })
    
    if (length(unique(na.omit(column_types))) > 1) {
      data_list <- lapply(data_list, function(df) {
        if (col %in% names(df)) df[[col]] <- as.character(df[[col]])
        return(df)
      })
    }
  }
  
  return(data_list)
}
```

```{r}
# === 5. Функция для объединения всех данных за диапазон годов ===
merging <- function(start_year, end_year, file_type, variables) {
  data_list <- load_all_data(start_year, end_year, file_type, variables)
  
  # Проверим, что data_list не пуст
  if (length(data_list) == 0) {
    stop("Ошибка: Не удалось загрузить данные для указанных годов.")
  }
  
  merged_data <- data_list[[as.character(start_year)]]
  for (year in (start_year + 1):end_year) {
    if (!is.null(data_list[[as.character(year)]])) {
      merged_data <- bind_rows(merged_data, data_list[[as.character(year)]])
    }
  }
  

  write.csv(merged_data, paste0("questions_answers/home_owner_ship/", file_type, "merged_data",".csv"), row.names = FALSE)
  
  return(merged_data)
}
```

```{r}
zp_data_list <- merging(2010, 2021, "zp_", c("HOUSEHOLDYEARLYID", variables_zp))
```



```{r}
# hhm_data_list <- merging(2010, 2021, "hhm_", c("HOUSEHOLDYEARLYID",variables_hhm))
```
