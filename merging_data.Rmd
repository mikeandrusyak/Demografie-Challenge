```{r}
library(dplyr)
source("Renaming_Columns.R")
```

```{r}
# Завантаження змінних з файлів
path_save = "questions_answers/home_owner_ship/"
variables_zp <- readRDS(paste0(path_save,"variables_zp.rds"))
variables_hh <- readRDS(paste0(path_save,"variables_hh.rds"))
# variables_hhm <- readRDS(paste0(path_save,"variables_hhm.rds"))
```

```{r}
# merged_variables <- c(vatriables_zp,variables_hh)
```

```{r}
# Функція для завантаження даних
load_data <- function(year, file_type, variables) {
  file_path <- paste0("data/strukturerhebung/", year, "_SE_RS_CSV/", file_type, year, ".csv")
  
  if (file.exists(file_path)) {
    if (year == 2011 & file_type == "hhm_"){
      data <- read.csv(file_path, sep = ",")
    }else{
    data <- read.csv(file_path, sep = ";")
    }
    colnames(data) <- toupper(colnames(data))
    data$YEAR_QUIZ <- year
    data <- data %>% select(any_of(c(variables, "YEAR_QUIZ")))
    return(data)
  } else {
    message(paste("Файл не знайдено:", file_path))
    return(NULL)
  }
}
```

```{r}

# Завантаження даних для всіх років за два типи файлів
load_all_data <- function(start_year, end_year, file_type, variables) {
  data_list <- list()
  
  for (year in start_year:end_year) {
    data <- load_data(year, file_type, variables)
    if (!is.null(data)) {
      data_list[[as.character(year)]] <- data
    }
  }
  
  return(data_list)
}
```

```{r}
# Функція для уніфікації типів колонок
unify_column_types <- function(data_list) {
  all_columns <- unique(unlist(lapply(data_list, names)))
  
  for (col in all_columns) {
    column_types <- sapply(data_list, function(df) {
      if (col %in% names(df)) class(df[[col]]) else NA
    })
    
    if (length(unique(na.omit(column_types))) > 1) {
      data_list <- lapply(data_list, function(df) {
        if (col %in% names(df)) df[[col]] <- as.character(df[[col]])
        return(df)
      })
    }
  }
  
  return(data_list)
}
```

```{r}
merging <- function(start_year, end_year, file_type, variables){
  data_list <- load_all_data(start_year, end_year, 
                             file_type, variables)
  
  rename_mappings <- list(
    "SECCITIZ" = "SECCITIZENSHIP",
    "WORKSTATUSDETAIL" = "WORKSTATUS_DETAIL"
  )
  
  data_list <- rename_columns(data_list, rename_mappings)
  data_list <- unify_column_types(data_list)
  
  
  merged_data <- data_list[[as.character(start_year)]]
  for (year in (start_year + 1):end_year) {
    if (!is.null(data_list[[as.character(year)]])) {
      merged_data <- bind_rows(merged_data, data_list[[as.character(year)]])
    }
  }
  
  write.csv(merged_data, paste0("questions_answers/home_owner_ship/", file_type, "merged_data",".csv"), row.names = FALSE)
  
  return(merged_data)
}
```

```{r}
hh_data_list <- merging(2010, 2021, "zp_", c("HOUSEHOLDYEARLYID", variables_zp))
```


```{r}
hh_data_list <- merging(2010, 2021, "hh_", c("HOUSEHOLDYEARLYID", variables_hh))
```

```{r}
# Завантажуємо дані для hhm та hh окремо
# hhm_data_list <- merging(2010, 2021, "hhm_", c("HOUSEHOLDYEARLYID",variables_hhm))
```
