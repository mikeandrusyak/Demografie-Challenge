```{r}
library(dplyr)
```

```{r}
# Завантаження змінних з файлів
zp_variables <- readRDS("zp_variables.rds")
hh_variables <- readRDS("hh_variables.rds")
hhm_variables <- readRDS("hhm_variables.rds")
```

```{r}
merged_variables <- c(zp_variables,hh_variables)
```

```{r}
# Функція для завантаження даних
load_data <- function(year, file_type, variables) {
  file_path <- paste0("data/strukturerhebung/", year, "_SE_RS_CSV/", file_type, year, ".csv")
  
  if (file.exists(file_path)) {
    data <- read.csv(file_path, sep = ";")
    data$YEAR_QUIZ <- year
    data <- data %>% select(any_of(c(variables, "YEAR_QUIZ")))
    return(data)
  } else {
    message(paste("Файл не знайдено:", file_path))
    return(NULL)
  }
}
```

```{r}

# Завантаження даних для всіх років за два типи файлів
load_all_data <- function(start_year, end_year, file_type, variables) {
  data_list <- list()
  
  for (year in start_year:end_year) {
    data <- load_data(year, file_type, variables)
    if (!is.null(data)) {
      data_list[[year]] <- data
    }
  }
  
  return(data_list)
}
```

```{r}
# Function to rename columns across multiple data frames in a list
rename_columns <- function(data_list, rename_mappings) {
  # Loop through each data frame in the list
  for (year in names(data_list)) {
    # Loop through each old column name in the renaming mappings
    for (old_name in names(rename_mappings)) {
      new_name <- rename_mappings[[old_name]]
      
      # Check if the old name exists in the data frame for that year
      if (old_name %in% names(data_list[[year]])) {
        # Rename the column
        data_list[[year]] <- data_list[[year]] %>%
          rename(!!new_name := !!sym(old_name))
        
        # Print a message to confirm renaming (optional)
        message(paste("Renamed", old_name, "to", new_name, "in year", year))
      }
    }
  }
  return(data_list)
}
```


```{r}
# Функція для уніфікації типів колонок
unify_column_types <- function(data_list) {
  all_columns <- unique(unlist(lapply(data_list, names)))
  
  for (col in all_columns) {
    column_types <- sapply(data_list, function(df) {
      if (col %in% names(df)) class(df[[col]]) else NA
    })
    
    if (length(unique(na.omit(column_types))) > 1) {
      data_list <- lapply(data_list, function(df) {
        if (col %in% names(df)) df[[col]] <- as.character(df[[col]])
        return(df)
      })
    }
  }
  
  return(data_list)
}
```

```{r}
merging <- function(start_year, end_year, file_type, variables){
  data_list <- load_all_data(start_year, end_year, 
                             file_type, variables)
  
  rename_mappings <- list(
    "SECCITIZ" = "SECCITIZENSHIP",
    "WORKSTATUSDETAIL" = "WORKSTATUS_DETAIL",
    "SOCIOECONOMICGROUP" = "SOCIOPROFGROUP",
    "hh_nationalityid" = "HH_NATIONALITYSTATE"
  )
  
  data_list <- rename_columns(data_list, rename_mappings)
  data_list <- unify_column_types(data_list)
  
  
  merged_data <- data_list[[start_year]]
  for (year in (start_year + 1):end_year) {
    if (!is.null(data_list[[year]])) {
      merged_data <- bind_rows(merged_data, data_list[[year]])
    }
  }
  
  write.csv(merged_data, paste0(file_type, "merged_data",".csv"), row.names = FALSE)
  
  return(merged_data)
}
```

```{r}
hh_data_list <- merging(2010, 2021, "hh_", merged_variables)
```

```{r}
head(hh_data_list)
```


```{r}
# Завантажуємо дані для hhm та hh окремо
hhm_data_list <- merging(2010, 2021, "hhm_", hhm_variables)
```

```{r}
head(hhm_data_list)
```


