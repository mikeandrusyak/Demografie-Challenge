```{r, message=FALSE}
library(dplyr)
library(ggplot2)
library(purrr)
source("chart_functions.R")
source("decode_lists.R")
```

```{r}
zp_merged_data <- read.csv("zp_merged_data.csv")
hh_merged_data <- read.csv("hh_merged_data.csv")
```

```{r}
# Об'єднання даних
merged_data <- hh_merged_data %>%
  left_join(zp_merged_data, by = c("HOUSEHOLDYEARLYID"="HOUSEHOLDYEARLYID","YEAR_QUIZ"="YEAR_QUIZ"))
```

```{r}
summary(merged_data)
```


```{r}
selected_data <- merged_data %>% select(RENTNET,NATIONALITYCAT,WORKSTATUS_DETAIL,
                          TIMEWORKEDPERWEEKSUM, RESIDENTPERMIT,CURROCCUPATIONISCOAGG)
```

```{r}
summary(selected_data)
```

```{r}
selected_data <- decode(selected_data, TIMEWORKEDPERWEEKSUM, list(
    "-9" = NA,
    "-8" = NA,
    "-7" = NA
  )
)
selected_data$TIMEWORKEDPERWEEKSUM <- as.numeric(as.character(selected_data$TIMEWORKEDPERWEEKSUM))
selected_data$TIMEWORKEDPERWEEKSUM %>% unique()
```

```{r}
selected_data %>% filter(!is.na(TIMEWORKEDPERWEEKSUM)) %>% 
  ggplot(aes(x = TIMEWORKEDPERWEEKSUM)) +
    geom_density(fill = "skyblue", alpha = 0.5) +  # Щільність розподілу
    labs(title = "Work time per week", x = "time", y = "density") +
    theme_minimal(base_size = 14)
```

```{r}
selected_data <- selected_data %>% mutate(
  WORK_TIME_GROUP = case_when(TIMEWORKEDPERWEEKSUM < 20 ~ "<50%",
                        TIMEWORKEDPERWEEKSUM >= 21 & TIMEWORKEDPERWEEKSUM <= 27 ~ "50-70%",
                        TIMEWORKEDPERWEEKSUM >= 29 & TIMEWORKEDPERWEEKSUM <= 36 ~ "70-90%",
                        TIMEWORKEDPERWEEKSUM >= 37 & TIMEWORKEDPERWEEKSUM <= 40 ~ "90-100%",
                        TIMEWORKEDPERWEEKSUM >= 41 & TIMEWORKEDPERWEEKSUM <= 44 ~ "100-110%",
                        TIMEWORKEDPERWEEKSUM >= 45 & TIMEWORKEDPERWEEKSUM <= 48 ~ "110-120%",
                        TIMEWORKEDPERWEEKSUM >= 49 ~ ">120%")
)
```

```{r}
selected_data <- selected_data %>%
  mutate(
    WORKSTATUS_DETAIL = if_else(
      YEAR_QUIZ > 2014 & WORKSTATUS_DETAIL %in% c(121, 122),
      case_match(WORKSTATUS_DETAIL, 121 ~ 111, 122 ~ 112),  
      WORKSTATUS_DETAIL                                   
    )
  )
```

```{r}
selected_data <- decode(selected_data, CURROCCUPATIONISCOAGG, occupation_isco_agg)
selected_data <- decode(selected_data, MAINLANGUAGEIAGG, main_languages)
selected_data <- decode(selected_data, MAINLANGUAGEIIAGG, main_languages)
selected_data <- decode(selected_data, MAINLANGUAGEIIIAGG, main_languages)
selected_data <- decode(selected_data, NATIONALITYCONTI, nationality_conti)
selected_data <- decode(selected_data, NATIONALITYCAT, nationality_category)
selected_data <- decode(selected_data, HIGHESTCOMPLEDUAGGII, education_level)
selected_data <- decode(selected_data, RESIDENTPERMIT, permit)
selected_data <- decode(selected_data, WORKSTATUS_DETAIL, work_status)
```

```{r}
distribution <- function(var){
    ggplot(selected_data, aes(x = {{var}})) +
    geom_bar(fill = "lightblue", color = "black") +
    ggtitle("Розподілення категорій") +
    xlab("Категорії") +
    ylab("Кількість") +
    theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 10), 
    axis.text.y = element_text(size = 10),                       
    legend.text = element_text(size = 10),                    
    plot.margin = margin(10, 20, 10, 10)  
  )
}
```


```{r}
foreigners <- selected_data %>% filter(NATIONALITYCAT == "Foreign")
```

```{r}
# Завантажуємо бібліотеки
library(dplyr)

# Підрахунок статистичних мір для іноземців та місцевих
summary_stats <- selected_data %>%
  group_by(NATIONALITYCAT) %>%
  summarise(
    mean_hours = mean(TIMEWORKEDPERWEEKSUM, na.rm = TRUE),      # Середнє
    median_hours = median(TIMEWORKEDPERWEEKSUM, na.rm = TRUE),  # Медіана
    sd_hours = sd(TIMEWORKEDPERWEEKSUM, na.rm = TRUE),          # Стандартне відхилення
    min_hours = min(TIMEWORKEDPERWEEKSUM, na.rm = TRUE),        # Мінімум
    max_hours = max(TIMEWORKEDPERWEEKSUM, na.rm = TRUE),        # Максимум
    Q1 = quantile(TIMEWORKEDPERWEEKSUM, probs = 0.25, na.rm = TRUE), # Перший квартиль
    Q3 = quantile(TIMEWORKEDPERWEEKSUM, probs = 0.75, na.rm = TRUE), # Третій квартиль
    count = n()                                                 # Кількість спостережень
  )

selected_data %>% filter(TIMEWORKEDPERWEEKSUM>0 & !is.na(NATIONALITYCAT)) %>% 
  ggplot(aes(x = NATIONALITYCAT, y = TIMEWORKEDPERWEEKSUM, fill = NATIONALITYCAT)) +
    geom_boxplot() +
    labs(
      title = "Comparison of Working Hours by Nationality",
      x = "Nationality",
      y = "Weekly Working Hours"
    ) +
    theme_minimal()

print(summary_stats)

# Додатково: Тест на значущість різниці (t-тест)
t_test <- t.test(TIMEWORKEDPERWEEKSUM ~ NATIONALITYCAT, data = selected_data)
print(t_test)
```
```{r}
rent_analysis <- selected_data %>%
  filter(!is.na(NATIONALITYCAT)) %>%
  mutate(
    pays_rent = case_when(
      RENTNET > 0 ~ "Pays Rent",
      RENTNET < 1 | is.na(RENTNET) ~ "Does Not Pay Rent"
    )
  ) %>%
  group_by(NATIONALITYCAT, pays_rent) %>%
  summarise(count = n(), .groups = "drop") %>% # Використовуємо .groups = "drop", щоб уникнути залишення груп
  group_by(NATIONALITYCAT) %>% # Групуємо тільки за NATIONALITYCAT для коректних розрахунків відсотків
  mutate(percentage = round(count / sum(count) * 100,2)) %>%
  ungroup() # Знімаємо всі групування, щоб уникнути можливих майбутніх конфліктів

ggplot(rent_analysis, aes(x = pays_rent, y = percentage, fill = NATIONALITYCAT)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Розподіл оплати оренди за категоріями національності",
       x = "Категорія національності",
       y = "Кількість",
       fill = "Статус оплати оренди") +
  theme_minimal()

print(rent_analysis)
```
```{r}
foreigners %>% 
  filter(!is.na(CURROCCUPATIONISCOAGG) & 
        !is.na(RESIDENTPERMIT)) %>% 
  ggplot(aes(x = CURROCCUPATIONISCOAGG, fill = RESIDENTPERMIT)) +
  geom_bar(position = "stack", na.rm = TRUE) +
  geom_text(
    aes(label = scales::percent(
      round(after_stat(count) / tapply(after_stat(count), 
                                       after_stat(x), sum)[after_stat(x)], 2))),
    stat = "count",
    position = position_stack(vjust = 0.5),
    size = 3
  ) +
  labs(
    title = paste("Occupation by permit"),
    x = "Occupation",
    y = "Proportion"
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
    axis.text.y = element_text(size = 10),
    legend.text = element_text(size = 10),
    plot.margin = margin(10, 20, 10, 10)
  )
```

```{r}
median_by_permit <- selected_data %>% filter(TIMEWORKEDPERWEEKSUM>0) %>% 
  select(RESIDENTPERMIT, TIMEWORKEDPERWEEKSUM) %>% 
  group_by(RESIDENTPERMIT) %>% 
  summarise(mean_time = round(mean(TIMEWORKEDPERWEEKSUM, na.rm = TRUE), 2), .groups = "drop") %>% 
  filter(!is.na(RESIDENTPERMIT)) %>% 
  arrange(desc(mean_time))

ggplot(median_by_permit, aes(x = reorder(RESIDENTPERMIT, -mean_time), y = mean_time, fill = RESIDENTPERMIT)) +
  geom_bar(stat = "identity") +
  labs(
    title = "Mean work time per week by permit",
    x = "Permit type",
    y = "Mean work time per week"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  guides(fill = "none")

print(median_by_permit)
```
```{r}
work_time_by_two_categories(selected_data, NATIONALITYCAT,WORKSTATUS_DETAIL)
```



