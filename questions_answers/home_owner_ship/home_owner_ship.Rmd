```{r}
# 1. Load required libraries
library(dplyr)     # For data manipulation
library(ggplot2)   # For plotting
```

```{r}
# 2. Read initial data
zp_merged_data <- read.csv("zp_merged_data.csv")
hh_merged_data <- read.csv("hh_merged_data.csv")
```

```{r}
# 3. Define a custom decode function
decode <- function(df, var, decode_mapping) {
  # Convert the keys in the list to text
  for (key in names(decode_mapping)) {
    value <- decode_mapping[[key]]
    df <- df %>%
      mutate({{ var }} := case_match(
        as.character({{ var }}),    # Convert the variable's values to text
        key ~ value,                # Match the key with the corresponding value
        .default = as.character({{ var }})  # Keep the original value if no match is found
      ))
  }
  return(df)
}
```

```{r}
# 4. Merge the datasets and select relevant columns
merged_data <- zp_merged_data %>%
  left_join(
    hh_merged_data, 
    by = c("HOUSEHOLDYEARLYID" = "HOUSEHOLDYEARLYID", "YEAR_QUIZ" = "YEAR_QUIZ")
  ) %>%
  select(
    HOUSEHOLDYEARLYID, 
    SECCITIZENSHIP, 
    TYPEOFOWNERSHIP,
    SIZEOFPRIVATEHOUSEHOLD,
    NATIONALITYCAT, 
    NATIONALITYCONTI
  )
```


```{r}
# 5. Quick checks
summary(merged_data)
str(merged_data)
```

```{r}
# 6. Clean data and decode categorical fields

# Remove rows where key fields are missing
cleaned_data <- merged_data %>%
  filter(
    !is.na(NATIONALITYCAT),
    !is.na(SIZEOFPRIVATEHOUSEHOLD),
    !is.na(TYPEOFOWNERSHIP)
  )

# Decode fields
cleaned_data <- decode(cleaned_data, SECCITIZENSHIP, list(
  "1" = "No",
  "2" = "Yes",
  "-6" = NA,
  "-8" = NA,
  "-9" = NA
))

cleaned_data <- decode(cleaned_data, TYPEOFOWNERSHIP, list(
  "1" = "Tenant or subtenant",
  "2" = "Cooperative member",
  "3" = "Condominium/apartment owner",
  "4" = "Owner of the house",
  "5" = "Other situation",
  "-9" = NA
))

cleaned_data <- decode(cleaned_data, NATIONALITYCAT, list(
  "1" = "Swiss",
  "2" = "Foreigner",
  "-8" = NA,
  "-9" = NA
))

cleaned_data <- decode(cleaned_data, NATIONALITYCONTI, list(
  "1" = "Switzerland",
  "2" = "Member State of the European Union (EU)",
  "3" = "Member state of EFTA",
  "4" = "Other European country",
  "5" = "Africa",
  "6" = "North America",
  "7" = "Latin America and the Caribbean",
  "8" = "Asia",
  "9" = "Oceania",
  "-1" = "Stateless",
  "-6" = NA,
  "-8" = NA,
  "-9" = NA
))
```

```{r}
# 7. Create additional variables and filter
# Replace -9 in TYPEOFOWNERSHIP with NA
cleaned_data <- cleaned_data %>%
  mutate(TYPEOFOWNERSHIP = ifelse(is.na(TYPEOFOWNERSHIP), NA, TYPEOFOWNERSHIP))

# Convert SECCITIZENSHIP to character, remove "NA" literal if present
cleaned_data <- cleaned_data %>%
  mutate(
    SECCITIZENSHIP = as.character(SECCITIZENSHIP),
    SECCITIZENSHIP = na_if(SECCITIZENSHIP, "NA")
  )

# Define homeownership (Owner vs. Renter)
cleaned_data <- cleaned_data %>%
  mutate(HOMEOWNERSHIP = case_when(
    TYPEOFOWNERSHIP %in% c("Condominium/apartment owner", "Owner of the house") ~ "Owner",
    TYPEOFOWNERSHIP %in% c("Tenant or subtenant", "Other situation") ~ "Renter",
    TRUE ~ NA_character_
  ))

# Remove rows where HOMEOWNERSHIP or AGE_GROUP is NA
cleaned_data <- cleaned_data %>%
  filter(!is.na(HOMEOWNERSHIP), !is.na(AGE_GROUP))
```


```{r}
# Group household size
cleaned_data <- cleaned_data %>%
  mutate(
    SIZEOFPRIVATEHOUSEHOLD_GROUP = case_when(
      SIZEOFPRIVATEHOUSEHOLD == 1 ~ "1 member",
      SIZEOFPRIVATEHOUSEHOLD >= 2 & SIZEOFPRIVATEHOUSEHOLD <= 3 ~ "2-3 members",
      SIZEOFPRIVATEHOUSEHOLD >= 4 ~ "4+ members",
      TRUE ~ NA_character_
    )
  ) %>%
  filter(!is.na(SIZEOFPRIVATEHOUSEHOLD_GROUP))
```

```{r}
create_proportional_plot <- function(data, group_var, fill_var, y_var, title, x_label, y_label, facet_var = NULL) {
  # Group and summarise data
  summarized_data <- data %>%
    group_by(across(all_of(c(group_var, fill_var, facet_var)))) %>%
    summarise(count = n(), .groups = "drop") %>%
    group_by(across(all_of(c(group_var, facet_var)))) %>%
    mutate(proportion = count / sum(count) * 100)
  
  # Create the base plot
  plot <- ggplot(summarized_data, aes_string(x = group_var, y = "proportion", fill = fill_var)) +
    geom_bar(stat = "identity", position = "fill") +
    geom_text(
      aes(label = sprintf("%.1f%%", proportion)), # Display percentages
      position = position_fill(vjust = 0.5),
      size = 3,
      color = "white"
    ) +
    scale_y_continuous(labels = scales::percent) + # Format y-axis as percentages
    labs(
      title = title,
      x = x_label,
      y = y_label,
      fill = "Category"
    ) +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
  
  # Add faceting if a facet variable is provided
  if (!is.null(facet_var)) {
    plot <- plot + facet_wrap(as.formula(paste("~", facet_var)))
  }
  
  return(plot)
}
```


```{r}
# 8. Various summaries and plots
# 8.1 Plot: Proportion of Homeownership by Nationality (SECCITIZENSHIP)
plot1 <- create_proportional_plot(
  data = cleaned_data,
  group_var = "NATIONALITYCAT",
  fill_var = "TYPEOFOWNERSHIP",
  y_var = "proportion",
  title = "Proportion of Homeownership by Nationality",
  x_label = "Nationality",
  y_label = "Proportion"
)
print(plot1)
```


```{r}
# 8.2 Example: Proportions by Continent of Nationality and Ownership
plot2 <- create_proportional_plot(
  data = cleaned_data %>%
    filter(
      !is.na(NATIONALITYCONTI) & 
      !(NATIONALITYCONTI %in% c("Switzerland", NA, "Stateless")) & 
      !is.na(TYPEOFOWNERSHIP)
    ),
  group_var = "NATIONALITYCONTI",
  fill_var = "TYPEOFOWNERSHIP",
  y_var = "proportion",
  title = "Homeownership by Continent",
  x_label = "Continent of Nationality",
  y_label = "Proportion"
)
print(plot2)
```

```{r}
# 8.3 Plot: Proportion of Homeownership by Citizenship
plot1 <- create_proportional_plot(
  data = cleaned_data,
  group_var = "SECCITIZENSHIP",
  fill_var = "HOMEOWNERSHIP",
  y_var = "proportion",
  title = "Proportion of Homeownership by Citizenship",
  x_label = "Citizenship",
  y_label = "Proportion"
)
print(plot1)
```

```{r}
# 8.4 Example of summarizing by household size
plot3 <- create_proportional_plot(
  data = cleaned_data, 
  group_var = "NATIONALITYCAT",
  fill_var = "HOMEOWNERSHIP",
  y_var = "proportion", 
  title = "Homeownership by Nationality and Household Size",
  x_label = "Nationality",
  y_label = "Proportion",
  facet_var = "SIZEOFPRIVATEHOUSEHOLD_GROUP"
)
print(plot3)
```