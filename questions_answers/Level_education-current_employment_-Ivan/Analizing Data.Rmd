
```{r}
library(vcd)
library(dplyr)
library(ggplot2)
```


```{r}
data <- read.csv("zp_merged_data.csv")
```


```{r}
#26 variables
selected_data <- data
head(selected_data)
```



```{r}

edu_decode_Ja <- function(df, column_name) {
  df %>%
    mutate(!!sym(column_name) := case_when(
      !!sym(column_name) == 0 ~ "Nein",
      !!sym(column_name) == 1 ~ "Ja",
      TRUE ~ as.character(!!sym(column_name))
    ))
}


columns_to_decode <- c(
                       "CURRACTIVITY_FULL", "CURRACTIVITY_PART",
                       "CURRACTIVITY_HOME","IN_EDUCATION")

decoded_data <- data
for (col in columns_to_decode) {
  decoded_data <- edu_decode_Ja(decoded_data, col)
}

decoded_data <- decoded_data %>%
  mutate(
    employment_type = case_when(
      CURRACTIVITY_FULL == "Ja" ~ "Full time",
      CURRACTIVITY_PART == "Ja" ~ "Part time",
      TRUE ~ "Unemployed"
    )
  )


```




```{r}
decoded_data <- decoded_data %>%
  mutate(
    CURRACTIVITYSTATUSIII = case_when(
      CURRACTIVITYSTATUSIII == 1 ~ "Full-time (90-100%)",
      CURRACTIVITYSTATUSIII == 2 ~ "Part-time I (70-89%)",
      CURRACTIVITYSTATUSIII == 3 ~ "Part-time II (50-69%)",
      CURRACTIVITYSTATUSIII == 4 ~ "Part-time III (<50%)",
      CURRACTIVITYSTATUSIII == 5 ~ "Unemployed",
      CURRACTIVITYSTATUSIII == 6 ~ "In training",
      CURRACTIVITYSTATUSIII == 7 ~ "Housewoman/Houseman",
      CURRACTIVITYSTATUSIII == 8 ~ "Retired",
      CURRACTIVITYSTATUSIII == 9 ~ "Other non-working",
      TRUE ~ as.factor(CURRACTIVITYSTATUSIII)
    ),
    HIGHESTCOMPLEDU = case_when(
      HIGHESTCOMPLEDU %in% c(1) ~ "No education",
      HIGHESTCOMPLEDU %in% c(2, 3) ~ "School education",
      HIGHESTCOMPLEDU %in% c(4, 5) ~ "College",
      HIGHESTCOMPLEDU %in% c(6) ~ "Professional training",
      HIGHESTCOMPLEDU %in% c(7, 8) ~ "Higher education (Bachelor/Master)",
      HIGHESTCOMPLEDU %in% c(9, 10) ~ "Advanced education (Doctorate/Technical)",
      TRUE ~ as.factor(HIGHESTCOMPLEDU)
    ),
    SEX = case_when(
      SEX %in% c (1) ~ "Male",
      SEX %in% c (2) ~ "Female",
      TRUE ~ as.factor(SEX)
    )
  )
```


```{r}
head(decoded_data)
```
```{r}


# Фильтрация недопустимых значений
decoded_data <- decoded_data %>%
  filter(HIGHESTCOMPLEDU %in% c("No education", 
                                "School education", 
                                "College", 
                                "Professional training", 
                                "Higher education (Bachelor/Master)", 
                                "Advanced education (Doctorate/Technical)"))


decoded_data <- decoded_data %>%
  filter(if_all(everything(), ~ . != "-9" & . != "-10"))

decoded_data <- decoded_data %>%
  mutate(
    CURRACTIVITYSTATUSIII = as.factor(CURRACTIVITYSTATUSIII),
    CURRACTIVITY_FULL = as.factor(CURRACTIVITY_FULL),
    CURRACTIVITY_PART = as.factor(CURRACTIVITY_PART),
    CURRACTIVITY_HOME = as.factor(CURRACTIVITY_HOME),
    IN_EDUCATION = as.factor(IN_EDUCATION),
    HIGHESTCOMPLEDU = as.factor(HIGHESTCOMPLEDU),
    HIGHESTCOMPLEDUAGGI = as.factor(HIGHESTCOMPLEDUAGGI),
    AGE = as.factor(AGE),
    SEX = as.factor(SEX),
    employment_type = as.factor(employment_type)
  )
decoded_data$HIGHESTCOMPLEDU <- factor(decoded_data$HIGHESTCOMPLEDU, levels = c(
  "No education",
  "School education",
  "College",
  "Professional training",
  "Higher education (Bachelor/Master)",
  "Advanced education (Doctorate/Technical)"
))
str(decoded_data)
```


```{r}
decoded_data <- decoded_data %>%
  filter(!CURRACTIVITYSTATUSIII %in% c("Andere Nichterwerbspersonen", "In Ausbildung", "Rentner/innen"))
levels(decoded_data$CURRACTIVITYSTATUSIII)
```



```{r}
employment_type_data <- decoded_data %>%
  filter(!is.na(HIGHESTCOMPLEDU)) %>%
  mutate(employment_type = case_when(
    CURRACTIVITY_FULL == "Ja" ~ "Full time",
    CURRACTIVITY_PART == "Ja" ~ "Part time",
    TRUE ~ "Unemployed"
  )) %>%
  group_by(HIGHESTCOMPLEDU, employment_type) %>%
  summarise(count = n()) %>%
  mutate(percentage = count / sum(count) * 100)

ggplot(employment_type_data, aes(x = HIGHESTCOMPLEDU, y = percentage, fill = employment_type)) +
  geom_bar(stat = "identity", position = "fill") +  
  geom_text(
    aes(
      label = sprintf("%.1f%%", percentage),
      group = employment_type
    ),
    position = position_fill(vjust = 0.5),
    size = 3
  ) +
  labs(
    title = "Distribution of employment types by education level",
    x = "Education Level",
    y = "Percent",
    fill = "Type of employment"
  ) +
  
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```




```{r}
# Рассчёт percentage
education_type_data <- decoded_data %>%
  group_by(employment_type, IN_EDUCATION) %>%
    summarise(count = n(), .groups = "drop") %>%
      mutate(percentage = count / sum(count) * 100)

# Построение графика
ggplot(education_type_data, aes(x = employment_type, y = percentage, fill = IN_EDUCATION)) +
  geom_bar(stat = "identity", position = "stack") +  
  geom_text(
    aes(label = sprintf("%.1f%%", percentage)),
    position = position_stack(vjust = 0.5),
    size = 3
  ) +
  labs(
    title = "Distribution of education status by highest education level",
    x = "Highest Education Level",
    y = "Percent",
    fill = "Education is ongoing"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
```{r}
# Пример: сгруппированные столбики 
# employment_type ~ HIGHESTCOMPLEDU, сгруппировано по SEX
# Сначала сформируем суммарные данные:

grouped_data <- decoded_data %>%
  filter(!is.na(HIGHESTCOMPLEDU), !is.na(SEX)) %>%
  group_by(HIGHESTCOMPLEDU, SEX, employment_type) %>%
  summarise(count = n(), .groups = "drop") %>%
  mutate(percentage = count / sum(count) * 100)

# Построим сгруппированную диаграмму
ggplot(grouped_data, aes(x = HIGHESTCOMPLEDU, y = percentage, fill = employment_type)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.8)) +
  facet_wrap(~ SEX) + 
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  labs(
    title = "Employment type by education level, grouped by sex",
    x = "Highest Education Level",
    y = "Percent",
    fill = "Type of employment"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
```{r}

# Пример: убедимся, что AGE - это числовая переменная
decoded_data <- decoded_data %>%
  mutate(AGE = as.numeric(as.character(AGE)))  # если фактически хранилась как factor/character

# Теперь строим boxplot
ggplot(decoded_data, aes(
  x = HIGHESTCOMPLEDU,
  y = AGE,
  fill = employment_type
)) +
  # Если хотим, чтобы для каждого уровня образования было по несколько боксов (Full time / Part time / Unemployed),
  # указываем group = interaction(HIGHESTCOMPLEDU, employment_type) и сдвигаем боксы:
  geom_boxplot(
    position = position_dodge(width = 0.9),
    aes(group = interaction(HIGHESTCOMPLEDU, employment_type))
  ) +
  labs(
    title = "Age distribution by education level and employment type",
    x = "Highest Education Level",
    y = "Age",
    fill = "Employment Type"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
```



